// æµ‹è¯•è„šæœ¬ï¼šéªŒè¯fetch-biorxiv-papers Edge Functionçš„é€»è¾‘
// è¿™ä¸ªè„šæœ¬æ¨¡æ‹ŸEdge Functionçš„æ ¸å¿ƒé€»è¾‘ï¼Œç”¨äºæœ¬åœ°æµ‹è¯•

// æ¨¡æ‹ŸRSSæ•°æ®ï¼ˆåŸºäºå®é™…BioRxiv RSSæ ¼å¼ï¼‰
const mockRSSData = `<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns="http://purl.org/rss/1.0/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:prism="http://purl.org/rss/1.0/modules/prism/">
  <channel rdf:about="https://biorxiv.org">
    <title>bioRxiv Subject Collection: All</title>
    <link>https://biorxiv.org</link>
    <description>This feed contains articles for bioRxiv Subject Collection "All"</description>
  </channel>
  <item rdf:about="https://www.biorxiv.org/content/10.1101/2025.11.11.687835v1?rss=1">
    <title><![CDATA[The Cerebellum Implements an Oscillatory Forward Model for Accurate Motor Timing]]></title>
    <link>https://www.biorxiv.org/content/10.1101/2025.11.11.687835v1?rss=1</link>
    <description><![CDATA[Voluntary movements are composed of small sub-movements generated by pulsatile bursts of muscle activity at 4-10 Hz.]]></description>
    <dc:creator><![CDATA[ Smith, J., Johnson, A., Brown, K. ]]></dc:creator>
    <dc:date>2025-11-11</dc:date>
    <dc:identifier>doi:10.1101/2025.11.11.687835</dc:identifier>
    <dc:publisher>Cold Spring Harbor Laboratory</dc:publisher>
    <prism:publicationDate>2025-11-11</prism:publicationDate>
  </item>
  <item rdf:about="https://www.biorxiv.org/content/10.1101/2025.11.11.687827v1?rss=1">
    <title><![CDATA[Accurate interpretation of within-host dissemination using barcoded bacteria]]></title>
    <link>https://www.biorxiv.org/content/10.1101/2025.11.11.687827v1?rss=1</link>
    <description><![CDATA[Bacterial dissemination across tissues is a critically important process influencing infection outcomes.]]></description>
    <dc:creator><![CDATA[ Giorgio, R. T., Zhang, T., Holmes, C. L. ]]></dc:creator>
    <dc:date>2025-11-11</dc:date>
    <dc:identifier>doi:10.1101/2025.11.11.687827</dc:identifier>
    <dc:publisher>Cold Spring Harbor Laboratory</dc:publisher>
    <prism:publicationDate>2025-11-11</prism:publicationDate>
  </item>
</rdf:RDF>`;

// æ¨¡æ‹ŸXMLè§£æå™¨
function parseXML(xmlText) {
  // ç®€åŒ–çš„XMLè§£æï¼Œå®é™…ä½¿ç”¨fast-xml-parser
  const items = [];
  const itemRegex = /<item[^>]*>(.*?)<\/item>/gs;
  let match;
  
  while ((match = itemRegex.exec(xmlText)) !== null) {
    const itemContent = match[1];
    
    const extractField = (content, tag) => {
      const regex = new RegExp(`<${tag}[^>]*><!\\[CDATA\\[(.*?)\\]\\]><\\/${tag}>`, 's');
      const match = content.match(regex);
      return match ? match[1] : '';
    };
    
    const extractSimpleField = (content, tag) => {
      const regex = new RegExp(`<${tag}[^>]*>(.*?)<\\/${tag}>`, 's');
      const match = content.match(regex);
      return match ? match[1] : '';
    };
    
    items.push({
      title: extractField(itemContent, 'title'),
      link: extractSimpleField(itemContent, 'link'),
      description: extractField(itemContent, 'description'),
      'dc:creator': extractField(itemContent, 'dc:creator'),
      'dc:date': extractSimpleField(itemContent, 'dc:date'),
      'dc:identifier': extractSimpleField(itemContent, 'dc:identifier'),
      'dc:publisher': extractSimpleField(itemContent, 'dc:publisher'),
      'prism:publicationDate': extractSimpleField(itemContent, 'prism:publicationDate')
    });
  }
  
  return { 'rdf:RDF': { item: items } };
}

// æµ‹è¯•DOIæå–é€»è¾‘
function extractDOI(identifier) {
  const doiMatch = identifier?.match(/doi:(10\.\d{4,}\/.+)/);
  return doiMatch ? doiMatch[1] : '';
}

// æµ‹è¯•ä½œè€…è§£æ
function parseAuthors(creatorString) {
  if (!creatorString) return [];
  
  return creatorString
    .split(/\s*,\s*/)
    .filter(author => author.trim().length > 0)
    .map(author => author.trim());
}

// æµ‹è¯•PDF URLæ„å»º
function buildPDFUrl(link) {
  return link.replace(/\?rss=1$/, '.full.pdf');
}

// ä¸»æµ‹è¯•å‡½æ•°
function testEdgeFunctionLogic() {
  console.log('ğŸ§ª å¼€å§‹æµ‹è¯•fetch-biorxiv-papers Edge Functioné€»è¾‘...\n');
  
  try {
    // è§£æRSSæ•°æ®
    const parsed = parseXML(mockRSSData);
    const items = Array.isArray(parsed['rdf:RDF']?.item) ? parsed['rdf:RDF'].item : [parsed['rdf:RDF']?.item].filter(Boolean);
    
    console.log(`âœ… è§£æåˆ° ${items.length} ç¯‡è®ºæ–‡`);
    
    // æµ‹è¯•æ¯ç¯‡è®ºæ–‡çš„å¤„ç†
    items.forEach((item, index) => {
      console.log(`\nğŸ“„ å¤„ç†ç¬¬ ${index + 1} ç¯‡è®ºæ–‡:`);
      
      // æå–DOI
      const doi = extractDOI(item['dc:identifier']);
      console.log(`   DOI: ${doi}`);
      
      // è§£æä½œè€…
      const authors = parseAuthors(item['dc:creator']);
      console.log(`   ä½œè€…: ${JSON.stringify(authors)}`);
      
      // æ„å»ºPDF URL
      const pdfUrl = buildPDFUrl(item.link);
      console.log(`   PDF URL: ${pdfUrl}`);
      
      // æ„å»ºè®ºæ–‡æ•°æ®
      const paperData = {
        title: item.title?.trim() || 'Untitled',
        authors: authors,
        abstract: item.description?.trim() || '',
        published_date: item['dc:date'] || item['prism:publicationDate'] || new Date().toISOString().split('T')[0],
        doi: doi,
        source_url: item.link,
        pdf_url: pdfUrl
      };
      
      console.log(`   æ ‡é¢˜: ${paperData.title}`);
      console.log(`   å‘å¸ƒæ—¥æœŸ: ${paperData.published_date}`);
      console.log(`   æ‘˜è¦é¢„è§ˆ: ${paperData.abstract.substring(0, 100)}...`);
      
      // éªŒè¯å…³é”®å­—æ®µ
      if (!doi) {
        console.log(`   âŒ è­¦å‘Š: æ— æ³•æå–DOI`);
      }
      if (!paperData.title) {
        console.log(`   âŒ è­¦å‘Š: ç¼ºå°‘æ ‡é¢˜`);
      }
      if (authors.length === 0) {
        console.log(`   âŒ è­¦å‘Š: æ²¡æœ‰ä½œè€…ä¿¡æ¯`);
      }
      
      console.log(`   âœ… è®ºæ–‡æ•°æ®å¤„ç†å®Œæˆ`);
    });
    
    console.log('\nâœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Edge Functioné€»è¾‘éªŒè¯æˆåŠŸã€‚');
    
  } catch (error) {
    console.error('\nâŒ æµ‹è¯•å¤±è´¥:', error.message);
    console.error(error.stack);
  }
}

// è¿è¡Œæµ‹è¯•
testEdgeFunctionLogic();